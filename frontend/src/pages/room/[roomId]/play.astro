---
/**
 * Player Page - Quiz Participant View
 *
 * Room-based routing: /room/ABC123/play
 * Players arrive here after joining through /join
 */

import { getCollection } from "astro:content";
import { getQuizName } from "../../../utils/quizUtils";
import Layout from "../../../layouts/Layout.astro";
import QuizPlayer from "../../../components/QuizPlayer.astro";
import Timer from "../../../components/Timer.astro";

// Get the room ID from the URL
const { roomId } = Astro.params;
if (!roomId) {
    return Astro.redirect("/");
}

// Get the quiz ID from the URL query parameter
const quizId = Astro.url.searchParams.get("quiz");
if (!quizId) {
    return Astro.redirect("/?error=no-quiz");
}

// Fetch all the questions for the quiz
const questions = await getCollection("quiz", ({ id }) =>
    id.startsWith(`${quizId}/`),
);
const sortedQuestions = questions.sort((a, b) => a.id.localeCompare(b.id));

// Convert questions metadata to JSON-serializable format for Alpine.js
// Use snake_case to match the Question interface in quizPlayer.ts
const questionsData = sortedQuestions.map((q, index) => ({
    index,
    type: q.data.type,
    options: q.data.options || [],
    time_limit: q.data.timeLimit,
    points: q.data.points,
    correct_answer: q.data.correctAnswer,
}));

// Quiz name
const quizName = getQuizName(quizId, questions);
---

<Layout title={`Play: ${quizName}`}>
    <div class="bg-gray-100 min-h-screen">
        <!-- Missing Participant ID Warning -->
        <div
            id="no-participant-warning"
            class="hidden fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50"
        >
            <div class="bg-white rounded-lg shadow-xl p-8 max-w-md">
                <div class="text-4xl mb-4 text-center">⚠️</div>
                <h2 class="text-xl font-bold text-red-800 mb-2">Not Joined</h2>
                <p class="text-gray-700 mb-4">
                    You haven't joined this room yet. Please join through the
                    join page.
                </p>
                <a
                    href="/join"
                    class="block w-full py-2 bg-purple-600 text-white text-center rounded-lg hover:bg-purple-700"
                >
                    Go to Join Page
                </a>
            </div>
        </div>

        <div class="container mx-auto px-4 py-8">
            <!-- Header -->
            <header class="mb-8">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">
                            {quizName}
                        </h1>
                        <p class="text-gray-600">
                            Room: <span class="font-semibold">{roomId}</span>
                        </p>
                    </div>
                    <a
                        href="/"
                        class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition"
                    >
                        ← Back
                    </a>
                </div>
            </header>

            <!-- Main Content -->
            <div class="max-w-4xl mx-auto space-y-6">
                <!-- Timer -->
                <Timer
                    timeLimit={30}
                    currentQuestionIndex={0}
                    totalQuestions={questionsData.length}
                />

                <!-- Quiz Player (unified question display + answer controls) -->
                <div id="player-controls-container">
                    <QuizPlayer
                        roomId={roomId}
                        sortedQuestions={sortedQuestions}
                        questionsData={questionsData}
                    />
                </div>
            </div>

            <!-- Instructions -->
            <div class="mt-8 p-6 bg-purple-50 rounded-lg">
                <h3 class="text-xl font-semibold mb-4">How to Play</h3>
                <ul class="list-disc list-inside space-y-2 text-gray-700">
                    <li>Wait for the host to start each question</li>
                    <li>Answer as quickly as possible for more points</li>
                    <li
                        set:html={`Build a streak by answering correctly multiple times in
                    a row`}
                    />
                    <li>Watch your position on the leaderboard!</li>
                </ul>
            </div>
        </div>
    </div>
</Layout>

<script is:inline define:vars={{ roomId }}>
    // Check for participant ID in sessionStorage
    const participantId = sessionStorage.getItem(`participant_id_${roomId}`);

    if (!participantId) {
        // Show warning if no participant ID found
        console.error("No participant ID found for this room");
        document
            .getElementById("no-participant-warning")
            .classList.remove("hidden");
    } else {
        // Inject participantId into the QuizPlayer component via data attribute
        const playerContainer = document.getElementById(
            "player-controls-container",
        );
        const quizPlayerElement = playerContainer.querySelector(
            "[data-participant-id]",
        );

        if (quizPlayerElement) {
            quizPlayerElement.setAttribute(
                "data-participant-id",
                participantId,
            );
        }
    }
</script>
