---
/**
 * Host Page - Quiz Control Panel
 *
 * Room-based routing: /room/ABC123/host
 * This page controls a specific quiz room session.
 */

import { getCollection } from "astro:content";
import Layout from "@layouts/Layout.astro";
import QuizHost from "@components/QuizHost.astro";
import Leaderboard from "@components/Leaderboard.astro";
import Question from "@components/Question.astro";
import { getQuizName } from "@lib/utils";

// Get the room ID from the URL
const { roomId } = Astro.params;

if (!roomId) {
    return Astro.redirect("/");
}

// Get the quiz ID from the URL query parameter
const quizId = Astro.url.searchParams.get("quiz");
if (!quizId) {
    return Astro.redirect("/?error=no-quiz");
}

// Fetch all the questions for the quiz
const questions = await getCollection("quiz", ({ id }) =>
    id.startsWith(`${quizId}/`),
);

// Fetch question order from backend to apply randomization
const BACKEND_API =
    import.meta.env.PUBLIC_BACKEND_API || "http://localhost:8000";

// Default to original (canonical) order
let orderedQuestions = questions.sort((a, b) => a.id.localeCompare(b.id));

try {
    const roomResponse = await fetch(`${BACKEND_API}/api/rooms/${roomId}`);
    if (roomResponse.ok) {
        const roomData = await roomResponse.json();
        const questionOrder = roomData.question_order || [];

        // Reorder questions based on backend mapping
        if (questionOrder.length > 0) {
            orderedQuestions = questionOrder.map(
                (idx: number) => questions[idx],
            );
        }
    }
} catch (error) {
    console.error("Failed to fetch question order, using default:", error);
}

// Convert questions metadata to JSON-serializable format for Alpine.js
// We'll render the actual question content server-side in the template
// Use orderedQuestions (randomized) instead of sortedQuestions
const questionsData = orderedQuestions.map((q, index) => ({
    index,
    type: q.data.type,
    options: q.data.options || [],
    time_limit: q.data.timeLimit,
    points: q.data.points,
    correct_answer: q.data.correctAnswer,
    validation_method: q.data.validationMethod,
    semantic_threshold: q.data.semanticThreshold,
}));

// Quiz name
const quizName = getQuizName(quizId, questions);
---

<Layout title={`Host: ${quizName}`}>
    <div class="bg-gray-100 min-h-screen" id="host-page" data-room-id={roomId}>
        <!-- Missing Host Secret Warning -->
        <div
            id="no-secret-warning"
            class="hidden fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50"
        >
            <div class="bg-white rounded-lg shadow-xl p-8 max-w-md">
                <div class="text-4xl mb-4 text-center">‚ö†Ô∏è</div>
                <h2 class="text-xl font-bold text-red-800 mb-2">
                    Not Authorized
                </h2>
                <p class="text-gray-700 mb-4">
                    You don't have permission to host this room. Only the person
                    who created the room can host it.
                </p>
                <a
                    href="/"
                    class="block w-full py-2 bg-blue-600 text-white text-center rounded-lg hover:bg-blue-700"
                >
                    Go to Home
                </a>
            </div>
        </div>

        <div class="container mx-auto px-4 py-8">
            <!-- Header -->
            <header class="mb-8">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">
                            {quizName}
                        </h1>
                        <p class="text-gray-600">Host Control Panel</p>
                    </div>
                    <a
                        href="/"
                        class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition"
                    >
                        ‚Üê Back
                    </a>
                </div>
            </header>

            <!-- Room Info Alert -->
            <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <div class="flex items-center gap-2 mb-2">
                    <span class="text-2xl">üéÆ</span>
                    <h2 class="text-lg font-semibold text-blue-900">
                        Room Code: {roomId}
                    </h2>
                </div>
                <p class="text-blue-700 text-sm mb-3">
                    Share this code with participants so they can join at: <strong
                        >{Astro.url.origin}/join</strong
                    >
                </p>
                <a
                    href={`/room/${roomId}/qr?quizName=${quizName}`}
                    target="_blank"
                    class="inline-block px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition font-semibold shadow-sm"
                >
                    Show QR Code
                </a>
            </div>

            <!-- Main Content Grid -->
            <div
                class="grid lg:grid-cols-3 gap-6"
                x-data={`{ currentQuestion: 0, totalQuestions: ${orderedQuestions.length} }`}
                id="host-coordinator"
            >
                <!-- Left Column: Question Display + Host Controls -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Current Question Display (dynamically updated by Alpine) -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h2 class="text-xl font-semibold mb-4">
                            Current Question <span
                                x-text="`(${Math.min(currentQuestion + 1, totalQuestions)}/${totalQuestions})`"
                                class="text-gray-500"></span>
                        </h2>

                        <!-- Question Content (shown when quiz is active) -->
                        <div x-show="currentQuestion < totalQuestions" x-cloak>
                            {
                                orderedQuestions.length > 0 ? (
                                    orderedQuestions.map((question, index) => (
                                        <Question
                                            question={question}
                                            questionIndex={index}
                                            mode="host"
                                        />
                                    ))
                                ) : (
                                    <div class="text-gray-500">
                                        There are no questions to display.
                                    </div>
                                )
                            }
                        </div>

                        <!-- Quiz Complete Message -->
                        <div
                            x-show="currentQuestion >= totalQuestions"
                            x-cloak
                            class="text-center py-12"
                        >
                            <div class="text-6xl mb-4">üéâ</div>
                            <p
                                class="text-2xl font-semibold text-gray-800 mb-2"
                            >
                                All Questions Presented
                            </p>
                            <p class="text-gray-600">
                                Check the leaderboard for final results.
                            </p>
                        </div>
                    </div>

                    <!-- Host Controls -->
                    <div id="host-controls-container">
                        <QuizHost
                            roomId={roomId}
                            totalQuestions={questionsData.length}
                            questionsData={questionsData}
                        />
                    </div>
                </div>

                <!-- Right Column: Leaderboard -->
                <div class="space-y-4">
                    <!-- Open Leaderboard Button -->
                    <a
                        href={`/leaderboard/${roomId}`}
                        target="_blank"
                        class="block w-full py-3 bg-purple-600 text-white text-center rounded-lg hover:bg-purple-700 transition font-semibold shadow-md"
                    >
                        üèÜ Open Leaderboard in New Tab
                    </a>

                    <!-- Embedded Leaderboard -->
                    <Leaderboard roomId={roomId} showTitle={true} />
                </div>
            </div>

            <!-- Debug Info -->
            <div class="mt-8 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <details>
                    <summary
                        class="cursor-pointer font-semibold text-gray-700 mb-2"
                    >
                        üîß Debug Info
                    </summary>
                    <div class="text-sm text-gray-600 space-y-2">
                        <p><strong>Room ID:</strong> {roomId}</p>
                        <p>
                            <strong>Questions loaded:</strong>
                            {questionsData.length}
                        </p>
                        <p>
                            <strong>Host Secret:</strong>
                            <span id="debug-host-secret">Loading...</span>
                        </p>
                    </div>
                </details>
            </div>
        </div>
    </div>
</Layout>

<script>
    import {
        checkAuth,
        showUnauthorizedModal,
        injectAuthData,
    } from "@lib/auth";
    import {
        setupQuestionChangeListener,
        updateDebugSecret,
    } from "@lib/alpine-helpers";

    // Get room ID from data attribute
    const hostPage = document.getElementById("host-page");
    const roomId = hostPage?.dataset.roomId;

    if (!roomId) {
        console.error("Room ID not found");
    } else {
        // Check host authorization
        const authResult = checkAuth(roomId, "host");

        if (!authResult.authorized) {
            showUnauthorizedModal("host");
        } else {
            // Update debug info
            updateDebugSecret("debug-host-secret", authResult.hostSecret);

            // Inject hostSecret into the QuizHost component via data attribute
            injectAuthData(
                "host-controls-container",
                "host-secret",
                authResult.hostSecret
            );

            // Set up Alpine.js event listener for question changes
            setupQuestionChangeListener("host-coordinator");
        }
    }
</script>
