---
/**
 * Join Room Page
 *
 * Players enter room code and nickname to join a quiz.
 */

import Layout from "../layouts/Layout.astro";

const BACKEND_API =
    import.meta.env.PUBLIC_BACKEND_API || "http://localhost:8000";

// Retrieve the room code from the query params
const roomCode = Astro.url.searchParams.get("code")?.toUpperCase();
---

<Layout title="Join Quiz">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-md mx-auto">
            <!-- Header -->
            <div class="text-center mb-8">
                <div class="text-6xl mb-4">üéÆ</div>
                <h1 class="text-4xl font-bold text-gray-800 mb-2">
                    Join a Quiz
                </h1>
                <p class="text-gray-600">Enter the room code from your host</p>
            </div>

            <!-- Join Form -->
            <div class="bg-white rounded-lg shadow-xl p-8">
                <form id="join-form" class="space-y-4">
                    <div>
                        <label
                            for="room-code"
                            class="block text-sm font-semibold text-gray-700 mb-2"
                        >
                            Room Code
                        </label>
                        <input
                            type="text"
                            id="room-code"
                            name="room-code"
                            value={roomCode ?? ""}
                            required
                            placeholder="ABCD1234"
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent uppercase"
                            maxlength="10"
                        />
                    </div>

                    <div>
                        <label
                            for="nickname"
                            class="block text-sm font-semibold text-gray-700 mb-2"
                        >
                            Your Nickname
                        </label>
                        <input
                            type="text"
                            id="nickname"
                            name="nickname"
                            required
                            placeholder="PythonPadawan"
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            maxlength="20"
                        />
                    </div>

                    <button
                        type="submit"
                        class="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 transition disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        Join Quiz ‚Üí
                    </button>
                </form>

                <!-- Error Message -->
                <div
                    id="error-message"
                    class="hidden mt-4 p-4 bg-red-50 border border-red-200 rounded-lg"
                >
                    <p class="text-red-800 text-sm"></p>
                </div>

                <!-- Loading State -->
                <div id="loading" class="hidden mt-4 text-center">
                    <div
                        class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-purple-600"
                    >
                    </div>
                    <p class="text-sm text-gray-600 mt-2">Joining room...</p>
                </div>
            </div>

            <!-- Back Link -->
            <div class="text-center mt-6">
                <a href="/" class="text-purple-600 hover:underline"
                    >‚Üê Back to Home</a
                >
            </div>
        </div>
    </div>
</Layout>

<script>
    import {
        joinRoom,
        validateJoinForm,
        setLoadingState,
        showError,
        hideError,
    } from "../lib/join-room";

    const form = document.getElementById("join-form") as HTMLFormElement;

    form.addEventListener("submit", async (e) => {
        e.preventDefault();

        // Get form values
        const roomCodeInput = document.getElementById("room-code") as HTMLInputElement;
        const nicknameInput = document.getElementById("nickname") as HTMLInputElement;

        const roomCode = roomCodeInput.value.trim().toUpperCase();
        const nickname = nicknameInput.value.trim();

        // Validation
        const validationError = validateJoinForm(roomCode, nickname);
        if (validationError) {
            showError(validationError);
            return;
        }

        // Show loading state
        setLoadingState(true);
        hideError();

        // Join room
        const result = await joinRoom({ roomCode, nickname });

        if (!result.success && result.error) {
            showError(result.error);
            setLoadingState(false);
        }
        // If success, the joinRoom function will redirect
    });
</script>
