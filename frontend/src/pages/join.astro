---
/**
 * Join Room Page
 *
 * Players enter room code and nickname to join a quiz.
 */

import Layout from "../layouts/Layout.astro";

const BACKEND_API =
    import.meta.env.PUBLIC_BACKEND_API || "http://localhost:8000";
---

<Layout title="Join Quiz">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-md mx-auto">
            <!-- Header -->
            <div class="text-center mb-8">
                <div class="text-6xl mb-4">üéÆ</div>
                <h1 class="text-4xl font-bold text-gray-800 mb-2">
                    Join a Quiz
                </h1>
                <p class="text-gray-600">Enter the room code from your host</p>
            </div>

            <!-- Join Form -->
            <div class="bg-white rounded-lg shadow-xl p-8">
                <form id="join-form" class="space-y-4">
                    <div>
                        <label
                            for="room-code"
                            class="block text-sm font-semibold text-gray-700 mb-2"
                        >
                            Room Code
                        </label>
                        <input
                            type="text"
                            id="room-code"
                            name="room-code"
                            required
                            placeholder="e.g., ABC123"
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent uppercase"
                            maxlength="20"
                        />
                    </div>

                    <div>
                        <label
                            for="nickname"
                            class="block text-sm font-semibold text-gray-700 mb-2"
                        >
                            Your Nickname
                        </label>
                        <input
                            type="text"
                            id="nickname"
                            name="nickname"
                            required
                            placeholder="e.g., CodeNinja"
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            maxlength="20"
                        />
                    </div>

                    <button
                        type="submit"
                        class="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 transition disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        Join Quiz ‚Üí
                    </button>
                </form>

                <!-- Error Message -->
                <div
                    id="error-message"
                    class="hidden mt-4 p-4 bg-red-50 border border-red-200 rounded-lg"
                >
                    <p class="text-red-800 text-sm"></p>
                </div>

                <!-- Loading State -->
                <div id="loading" class="hidden mt-4 text-center">
                    <div
                        class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-purple-600"
                    >
                    </div>
                    <p class="text-sm text-gray-600 mt-2">Joining room...</p>
                </div>
            </div>

            <!-- Back Link -->
            <div class="text-center mt-6">
                <a href="/" class="text-purple-600 hover:underline"
                    >‚Üê Back to Home</a
                >
            </div>
        </div>
    </div>
</Layout>

<script is:inline define:vars={{ BACKEND_API }}>
    const form = document.getElementById("join-form");
    const errorMessage = document.getElementById("error-message");
    const loading = document.getElementById("loading");
    const submitButton = form.querySelector('button[type="submit"]');

    form.addEventListener("submit", async (e) => {
        e.preventDefault();

        // Get form values
        const roomCode = document
            .getElementById("room-code")
            .value.trim()
            .toUpperCase();
        const nickname = document.getElementById("nickname").value.trim();

        // Validation
        if (!roomCode || !nickname) {
            showError("Please fill in all fields");
            return;
        }

        // Show loading state
        loading.classList.remove("hidden");
        errorMessage.classList.add("hidden");
        submitButton.disabled = true;

        try {
            console.log(`Joining room: ${roomCode} as ${nickname}`);

            // Call backend API to join room
            const response = await fetch(
                `${BACKEND_API}/api/rooms/${roomCode}/join`,
                {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ nickname: nickname }),
                },
            );

            if (!response.ok) {
                if (response.status === 404) {
                    throw new Error(
                        `Room "${roomCode}" not found. Check the code with your host.`,
                    );
                }
                const errorText = await response.text();
                throw new Error(`Failed to join room: ${errorText}`);
            }

            const data = await response.json();
            console.log("Joined room:", data);

            // Store participant ID in sessionStorage
            sessionStorage.setItem(
                `participant_id_${roomCode}`,
                data.participant_id,
            );

            // Store the quiz ID in sessionStorage
            sessionStorage.setItem(`quiz_id_${roomCode}`, data.quiz_id);

            // Redirect to play page for a given quiz ID
            console.log(
                `Redirecting to /room/${roomCode}/play (${data.quiz_id})`,
            );
            window.location.href = `/room/${roomCode}/play?quiz_id=${data.quiz_id}`;
        } catch (error) {
            console.error("Failed to join room:", error);
            showError(error.message);
            submitButton.disabled = false;
            loading.classList.add("hidden");
        }
    });

    function showError(message) {
        errorMessage.classList.remove("hidden");
        errorMessage.querySelector("p").textContent = message;
    }
</script>
