---
/**
 * Create Room Page
 *
 * This page calls the backend API to create a real quiz room,
 * then redirects to the host page with the real room ID.
 */

import Layout from '../layouts/Layout.astro';

const BACKEND_API = import.meta.env.PUBLIC_BACKEND_API || 'http://localhost:8000';

// Get quiz parameter from URL
const quizId = Astro.url.searchParams.get('quiz') || 'test-quiz';
---

<Layout title="Creating Room...">
  <div class="container mx-auto px-4 py-8">
    <div class="max-w-md mx-auto">
      <!-- Loading State -->
      <div id="loading" class="text-center">
        <div class="text-6xl mb-4 animate-bounce">⏳</div>
        <h1 class="text-3xl font-bold mb-4">Creating Quiz Room...</h1>
        <p class="text-gray-600">Setting up your quiz session</p>
        <div class="mt-4 flex justify-center">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
        </div>
      </div>

      <!-- Error State -->
      <div id="error" class="hidden">
        <div class="bg-red-50 border-2 border-red-200 rounded-lg p-6">
          <div class="text-4xl mb-4 text-center">❌</div>
          <h2 class="text-xl font-bold text-red-800 mb-2">Connection Error</h2>
          <p class="text-red-700 mb-4" id="error-message"></p>

          <div class="space-y-3 text-sm text-red-600 bg-red-100 p-4 rounded">
            <p><strong>⚠️ Backend is not running!</strong></p>
            <p>Open a terminal and run:</p>
            <pre class="bg-red-200 p-2 rounded text-xs overflow-x-auto">cd backend
uv run uvicorn main:app --reload</pre>
            <p class="text-xs">Backend should be accessible at:</p>
            <code class="bg-red-200 px-2 py-1 rounded text-xs">{BACKEND_API}</code>
          </div>

          <button
            onclick="location.reload()"
            class="mt-4 w-full py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition"
          >
            Try Again
          </button>
          <a
            href="/"
            class="block mt-2 text-center text-red-600 hover:underline"
          >
            ← Back to Home
          </a>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script define:vars={{ BACKEND_API, quizId }}>
  // This runs when the page loads
  async function createRoom() {
    try {
      console.log(`Creating room for quiz: ${quizId}`);
      console.log(`Backend API: ${BACKEND_API}`);

      // Call backend API to create a room
      const response = await fetch(`${BACKEND_API}/api/rooms/create?quiz_id=${quizId}`, {
        method: 'POST',
      });

      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`Backend returned ${response.status}: ${errorText}`);
      }

      const data = await response.json();
      console.log('Room created:', data);

      // Store the host secret in sessionStorage so the host page can use it
      sessionStorage.setItem(`host_secret_${data.room_id}`, data.host_secret);

      // Redirect to host page with the real room ID
      console.log(`Redirecting to /room/${data.room_id}/host`);
      window.location.href = `/room/${data.room_id}/host`;

    } catch (error) {
      console.error('Failed to create room:', error);

      // Show error message
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('error').classList.remove('hidden');
      document.getElementById('error-message').textContent = error.message;
    }
  }

  // Create room when page loads
  createRoom();
</script>
