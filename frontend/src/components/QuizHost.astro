---
/**
 * Quiz Host Component (Alpine.js)
 *
 * Host control panel for managing quiz flow.
 * Uses the registered 'quizHost' Alpine component from alpine/quizHost.ts
 *
 * Note: hostSecret should be set via data-host-secret attribute,
 * typically from sessionStorage on the page level.
 */

interface QuestionData {
    index: number;
    type: string;
    options: string[];
    time_limit: number;
    points: number;
    correct_answer: string[];
}

interface Props {
    roomId: string;
    totalQuestions: number;
    questionsData: QuestionData[];
}

const { roomId, totalQuestions, questionsData } = Astro.props;
---

<div
    x-data={`quizHost({ roomId: '${roomId}', totalQuestions: ${totalQuestions}, questionsData: ${JSON.stringify(questionsData)} })`}
    x-init="init()"
    data-host-secret=""
    class="rounded-lg bg-white shadow-lg p-6"
>
    <h2 class="text-2xl font-bold mb-4">Host Controls</h2>

    <div class="mb-6 p-4 bg-gray-100 rounded">
        <div class="font-semibold">
            Room Code: <span x-text="roomId"></span>
        </div>
        <div class="text-sm text-gray-600">
            Participants: <span x-text="participantCount"></span>
        </div>
        <div class="text-sm text-gray-600">
            Question: <span
                x-text="Math.min(currentQuestion + 1, totalQuestions)"></span> /
            <span x-text="totalQuestions"></span>
        </div>
    </div>

    <div class="space-y-3">
        <!-- Start question button (idle) -->
        <button
            x-show="questionStatus === 'idle'"
            @click="startQuestion(questionsData[currentQuestion].time_limit || 10)"
            class="w-full py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition"
        >
            Start Question
        </button>

        <!-- Question is active (countdown running) -->
        <div
            x-show="questionStatus === 'active'"
            class="p-3 bg-green-100 text-green-800 rounded text-center font-semibold"
        >
            ‚è≥ Question Active ‚Ä¢ <span x-text="hostTimeLeft"></span>s
        </div>

        <!-- Question's timer is expired -->
        <div
            x-show="questionStatus === 'over'"
            class="p-3 bg-blue-100 text-blue-800 rounded text-center font-semibold"
        >
            ‚úÖ Question is over
        </div>

        <!-- Quiz is complete -->
        <div
            x-show="questionStatus === 'complete'"
            class="p-4 bg-green-100 text-green-800 rounded text-center font-semibold border-2 border-green-400"
        >
            üéâ Quiz Complete!
            <div class="text-sm font-normal mt-2">
                All questions have been presented. Check the leaderboard for
                final results.
            </div>
        </div>

        <!-- Next Question button (not on final question) -->
        <button
            x-show="currentQuestion < totalQuestions - 1 && questionStatus !== 'complete'"
            @click="nextQuestion()"
            :disabled="questionStatus !== 'over'"
            class="w-full py-3 rounded-lg font-semibold transition"
            :class="{
                'bg-blue-600 hover:bg-blue-700 text-white cursor-pointer': questionStatus === 'over',
                'bg-gray-300 text-gray-500 cursor-not-allowed': questionStatus !== 'over'
            }"
        >
            Next Question
        </button>

        <!-- Finish Quiz button (on final question) -->
        <button
            x-show="currentQuestion === totalQuestions - 1 && questionStatus === 'over'"
            @click="nextQuestion()"
            class="w-full py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold transition"
        >
            üèÅ Finish Quiz
        </button>

        <div
            x-show="isFinalQuestion && questionStatus === 'active'"
            class="p-3 bg-yellow-100 text-yellow-800 rounded text-center font-semibold"
        >
            Final Question
        </div>
    </div>

    <div class="mt-6">
        <h3 class="font-semibold mb-2">
            Participants (<span x-text="participantCount"></span>)
        </h3>
        <div class="max-h-40 overflow-y-auto">
            <template x-if="participants.length === 0">
                <p class="text-gray-500 text-sm">
                    Waiting for participants to join...
                </p>
            </template>

            <template x-if="participants.length > 0">
                <table class="w-full text-sm border-collapse">
                    <thead>
                        <tr class="border-b border-gray-200">
                            <th
                                class="text-left py-2 px-3 font-semibold text-gray-700 bg-gray-50"
                            >
                                Nickname
                            </th>
                            <th
                                class="text-left py-2 px-3 font-semibold text-gray-700 bg-gray-50"
                            >
                                Joined At
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <template
                            x-for="(participant, idx) in participants"
                            :key="participant.id"
                        >
                            <tr
                                class="border-b border-gray-100 hover:bg-gray-50"
                            >
                                <td
                                    class="py-2 px-3"
                                    x-text="participant.nickname"
                                >
                                </td>
                                <td
                                    class="py-2 px-3 text-gray-600 text-xs"
                                    x-text="new Date(participant.joined_at).toLocaleTimeString()"
                                >
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </template>
        </div>
    </div>
</div>
